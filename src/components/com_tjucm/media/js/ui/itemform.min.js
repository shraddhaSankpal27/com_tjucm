var tjucmRelatedFieldUpdatedOptions="",tjUcmTinyMCEFieldIds=new Array,tjUcmClickedOnNext=0,tjUcmClickedOnPrev=0,tjUcmCurrentAutoSaveState=0,tjUcmFormFinalSave=0;jQuery(window).load(function(){if(1===Number(jQuery("#itemState").val())){if(1==jQuery("#item-form #tjucm-autosave").val()){tjUcmCurrentAutoSaveState=1,jQuery("#item-form").on("change select",":input",function(){tjUcmCurrentAutoSaveState&&tjUcmItemForm.onUcmFormChange(this)}),jQuery("#item-form .field-calendar input:text").blur(function(){tjUcmCurrentAutoSaveState&&tjUcmItemForm.onUcmFormChange(this)});var e=Joomla.getOptions("plg_editor_tinymce");null!=e&&(jQuery.each(e.tinyMCE,function(e,t){if(jQuery("#item-form #jform_"+e).length){var a=jQuery("#jform_"+e+"_ifr").contents().find("body").html();tjUcmTinyMCEFieldIds[e]=a}else if(0==jQuery("#item-form #jform_"+e).length&&"default"!=e){var r=jQuery("textarea[id$='__"+e+"']");r.length&&jQuery.each(r,function(e,t){var a=jQuery(t).attr("id"),r=jQuery("#"+a+"_ifr").contents().find("body").html(),i=a.replace("jform_","");tjUcmTinyMCEFieldIds[i]=r})}}),setInterval(function(){for(var e in tjUcmTinyMCEFieldIds)if(tjUcmTinyMCEFieldIds.hasOwnProperty(e)){var t=jQuery("#jform_"+e+"_ifr").contents().find("body").html();if(tjUcmTinyMCEFieldIds[e]!=t){var a=jQuery("#jform_"+e);a.val(t),tjUcmTinyMCEFieldIds[e]=t,tjUcmItemForm.onUcmFormChange(a)}}},7e3))}}else jQuery("#tjucm-auto-save-disabled-msg").show();jQuery("#tjucm_myTabTabs a").on("click",function(){jQuery(this).parent().next("li").length?jQuery("#next_button").attr("disabled",!1):jQuery("#next_button").attr("disabled",!0),jQuery(this).parent().prev("li").length?jQuery("#previous_button").attr("disabled",!1):jQuery("#previous_button").attr("disabled",!0)}),jQuery(document).on("subform-row-add",function(e,t){var a=jQuery(t).attr("data-group").replace(jQuery(t).attr("data-base-name"),"");if(jQuery(t).find(".js-editor-tinymce textarea")){var r=jQuery(t).find(".js-editor-tinymce textarea").attr("id");if(r){var i=jQuery("#"+r+"_ifr").contents().find("body").html();r=r.replace("jform_",""),tjUcmTinyMCEFieldIds[r]=i}}jQuery.each(tjucmRelatedFieldUpdatedOptions,function(e,r){if(r.templateId){var i=r.templateId.replace("XXX_XXX",a);jQuery(t).find("#"+i).html(""),jQuery.each(r.options,function(e,a){jQuery(t).find("#"+i).append('<option value="'+a.value+'">'+a.text+"</option>")}),jQuery(t).find("#"+i).trigger("liszt:updated")}})}),jQuery("#next_button, #previous_button").on("click",function(){if("next_button"==jQuery(this).attr("id")?tjUcmClickedOnNext=1:tjUcmClickedOnPrev=1,jQuery("#item-form").hasClass("dirty"))if(tjUcmCurrentAutoSaveState){var e=jQuery(jQuery("#tjucm_myTabTabs > .active a").attr("href")).find("input, textarea, select, fieldset");tjUcmItemForm.validateSection(e)?tjUcmItemForm.saveSectionData(jQuery("#tjucm_myTabTabs > .active a").attr("href")):(tjUcmClickedOnNext=0,tjUcmClickedOnPrev=0)}else{e=jQuery(jQuery("#tjucm_myTabTabs > .active a").attr("href")).find("input, textarea, select, fieldset");tjUcmItemForm.validateSection(e)?(jQuery("#system-message-container").html(""),tjUcmClickedOnNext&&(tjUcmClickedOnNext=0,jQuery("#tjucm_myTabTabs > .active").next("li").find("a").trigger("click"),tjUcmItemForm.setVisibilityOfNavigationButtons()),tjUcmClickedOnPrev&&(tjUcmClickedOnPrev=0,jQuery("#tjucm_myTabTabs > .active").prev("li").find("a").trigger("click"),tjUcmItemForm.setVisibilityOfNavigationButtons())):(tjUcmClickedOnNext=0,tjUcmClickedOnPrev=0),jQuery("html, body").animate({scrollTop:jQuery("#item-form").position().top},"slow")}else{e=jQuery(jQuery("#tjucm_myTabTabs > .active a").attr("href")).find("input, textarea, select, fieldset");tjUcmItemForm.validateSection(e)?(jQuery("#system-message-container").html(""),tjUcmClickedOnNext&&(tjUcmClickedOnNext=0,jQuery("#tjucm_myTabTabs > .active").next("li").find("a").trigger("click"),tjUcmItemForm.setVisibilityOfNavigationButtons()),tjUcmClickedOnPrev&&(tjUcmClickedOnPrev=0,jQuery("#tjucm_myTabTabs > .active").prev("li").find("a").trigger("click"),tjUcmItemForm.setVisibilityOfNavigationButtons())):(tjUcmClickedOnNext=0,tjUcmClickedOnPrev=0),jQuery("html, body").animate({scrollTop:jQuery("#item-form").position().top},"slow")}})});var tjUcmItemForm={getUcmParentRecordId:function(e,t){var a=jQuery("#item-form").find("input[name='jform[client]']").val();new Promise(function(t,r){var i=jQuery("#item-form").find("input[name='jform[id]']").val();if(""==i){var n=new FormData;""!=a&&n.append("client",a),n.append(Joomla.getOptions("csrf.token"),1);n.append("draft",e),com_tjucm.Services.Item.create(n,function(e,a){if(a=JSON.parse(a),null==e)if(null!==a.data&&jQuery.isNumeric(a.data.id)){jQuery("#item-form").find("input[name='jform[id]']").val(a.data.id);var i=window.location.href.split("#")[0],n=-1===i.indexOf("?")?"?":"&",o="id="+a.data.id;i.indexOf(o)>=0||(i+=n+o),history.pushState(null,null,i),t(a.data.id)}else r(a)})}else jQuery.isNumeric(i)&&0!=i&&t(i)}).then(function(e){t(e)}).catch(function(e){return console.log(e),!1})},onUcmFormChange:function(e){jQuery(".form-actions button[type='button'], .form-actions input[type='button']").attr("disabled",!0),tjUcmItemForm.getUcmParentRecordId(1,function(t){var a=jQuery("#item-form").find("input[name='jform[client]']").val();tjUcmItemForm.initUcmFormFieldDataSave(e,a,t)})},initUcmFormFieldDataSave:function(e,t,a){jQuery(".form-actions button[type='button'], .form-actions input[type='button']").attr("disabled",!0);var r="",i=new FormData;if(i.append(Joomla.getOptions("csrf.token"),1),void 0!==jQuery(e).parent().parent().parent().attr("data-base-name")||void 0!==jQuery(e).parent().parent().parent().parent().attr("data-base-name")){var n=jQuery(e).parent().parent().parent().attr("data-base-name");null==n&&(n=jQuery(e).parent().parent().parent().parent().attr("data-base-name"));var o=jQuery(e).attr("id"),u="com_tjucm."+(r=o.replace(o.split("_").pop(),"contentid")).split("__").pop().replace("_contentid","").replace("com_tjucm_",""),m=jQuery("#"+r).val();if(""==m){i.append("parent_id",a),i.append("client",u),i.append("draft",1),com_tjucm.Services.Item.create(i,function(o,m){if(m=JSON.parse(m),null==o)return null!==m.data&&jQuery.isNumeric(m.data.id)&&jQuery("#"+r).val(m.data.id),i.append("jform["+n+"]",u),i.append("client",t),i.append("recordid",a),com_tjucm.Services.Item.saveFieldData(i,function(t,a){var r="[]"==jQuery(e).attr("name").slice(-2)?"[]":"",i="jform["+jQuery(e).attr("id").split("__").pop()+"]"+r;jQuery(e).attr("name",i),tjUcmItemForm.saveUcmFormFieldData(u,m.data.id,e)}),!0})}else if(jQuery.isNumeric(m)&&0!=m){var l="[]"==jQuery(e).attr("name").slice(-2)?"[]":"",c="jform["+jQuery(e).attr("id").split("__").pop()+"]"+l;return jQuery(e).attr("name",c),tjUcmItemForm.saveUcmFormFieldData(u,m,e),!0}return!1}return tjUcmItemForm.saveUcmFormFieldData(t,a,e),!0},saveUcmFormFieldData:function(e,t,a){jQuery(".form-actions button[type='button'], .form-actions input[type='button']").attr("disabled",!0);var r=new FormData;return r.append(Joomla.getOptions("csrf.token"),1),r.append("client",e),r.append("recordid",t),"checkbox"==jQuery(a).attr("type")?1==jQuery(a).prop("checked")?r.append(jQuery(a).attr("name"),1):r.append(jQuery(a).attr("name"),0):jQuery(a).hasClass("tjfieldTjList")?(""!=jQuery(a).val()&&null!=jQuery(a).val()&&r.append(jQuery(a).attr("name"),jQuery(a).val()),""!=jQuery("input#"+jQuery(a).attr("id")).val()&&null!=jQuery("input#"+jQuery(a).attr("id")).val()&&r.append(jQuery(a).attr("name"),jQuery("input#"+jQuery(a).attr("id")).val())):"tagsinput"==jQuery("input#"+jQuery(a).attr("id")).data("role")?(""!=jQuery("#"+jQuery(a).attr("id")).val()&&null!=jQuery("#"+jQuery(a).attr("id")).val()&&r.append(jQuery(a).attr("name"),jQuery("#"+jQuery(a).attr("id")).val()),""!=jQuery(a).val()&&null!=jQuery(a).val()&&r.append(jQuery(a).attr("name"),jQuery(a).val())):"file"!=jQuery(a).attr("type")?r.append(jQuery(a).attr("name"),jQuery(a).val()):r.append(jQuery(a).attr("name"),jQuery(a)[0].files[0]),""!=jQuery(a).attr("name")&&null!=jQuery(a).attr("name")&&com_tjucm.Services.Item.saveFieldData(r,tjUcmItemForm.afterDataSave),!0},afterDataSave:function(e,t){if(t=JSON.parse(t),jQuery("#item-form").removeClass("dirty"),null==t)return!1;if(jQuery(".form-actions button[type='button'], .form-actions input[type='button']").attr("disabled",!1),null!=t.data&&t.data.childContentIds&&jQuery.each(t.data.childContentIds,function(e,t){jQuery("#"+e).val(t)}),t.data&&tjUcmFormFinalSave&&(jQuery("#tjucm-auto-save-disabled-msg").show(),jQuery("#itemState").val(0),jQuery("#tjUcmSectionDraftSave").remove(),tjUcmCurrentAutoSaveState=0,tjUcmFormFinalSave=0),tjUcmClickedOnNext&&(tjUcmClickedOnNext=0,jQuery("#tjucm_myTabTabs > .active").next("li").find("a").trigger("click")),tjUcmClickedOnPrev&&(tjUcmClickedOnPrev=0,jQuery("#tjucm_myTabTabs > .active").prev("li").find("a").trigger("click")),tjUcmItemForm.setVisibilityOfNavigationButtons(),t.data){var a=jQuery("#item-form").find("input[name='jform[client]']").val(),r=jQuery("#item-form").find("input[name='jform[id]']").val();tjUcmItemForm.updateRelatedFieldsOptions(a,r)}tjUcmItemForm.renderResponseMessages(t)},renderResponseMessages:function(e){null!=e&&(null!==e.message&&(e.data?Joomla.renderMessages({success:[e.message]}):Joomla.renderMessages({error:[e.message]}),jQuery("html, body").animate({scrollTop:jQuery("#item-form").position().top},"slow")),null!==e.messages&&null!==e.messages.error&&(jQuery.each(e.messages.error,function(e,t){Joomla.renderMessages({error:[t]})}),jQuery("html, body").animate({scrollTop:jQuery("#item-form").position().top},"slow")))},updateRelatedFieldsOptions:function(e,t){var a=new FormData;a.append("client",e),a.append("content_id",t),com_tjucm.Services.Item.getUpdatedRelatedFieldsOptions(a,function(e,t){if(t=JSON.parse(t),""==(tjucmRelatedFieldUpdatedOptions=t.data))return!1;jQuery.each(t.data,function(e,t){jQuery("#"+t.elementId).html(""),jQuery.each(t.options,function(e,a){var r="";"1"==a.selected&&(r=' selected="selected" '),jQuery("#"+t.elementId).append('<option value="'+a.value+'" '+r+">"+a.text+"</option>")}),jQuery("#"+t.elementId).trigger("liszt:updated")})})},saveUcmFormData:function(){jQuery(".form-actions button[type='button'], .form-actions input[type='button']").attr("disabled",!0);var e=event.target.id,t=1;if("tjUcmSectionFinalSave"==e){if(!document.formvalidator.isValid(document.getElementById("item-form")))return tjUcmItemForm.setVisibilityOfNavigationButtons(),jQuery(".form-actions button[type='button'], .form-actions input[type='button']").attr("disabled",!1),jQuery("html, body").animate({scrollTop:jQuery("#item-form").position().top},"slow"),!1;if(!confirm(Joomla.JText._("COM_TJUCM_ITEMFORM_SUBMIT_ALERT")))return jQuery(".form-actions button[type='button'], .form-actions input[type='button']").attr("disabled",!1),!1;jQuery("#system-message-container").html(""),jQuery(".form-actions button[type='button'], .form-actions input[type='button']").attr("disabled",!0),t=0}jQuery("#item-form .toggle-editor a").each(function(e){this.click()}),tjUcmItemForm.getUcmParentRecordId(t,function(){var t=document.getElementById("item-form"),a=new FormData(t);a.delete("task"),a.delete("option"),a.delete("view"),a.delete("layout");var r=jQuery("#item-form").find("input[name='jform[client]']").val(),i=jQuery("#item-form").find("input[name='jform[id]']").val();a.append(Joomla.getOptions("csrf.token"),1),a.append("client",r),a.append("recordid",i),"tjUcmSectionDraftSave"==e&&a.append("draft",1),"tjUcmSectionFinalSave"==e&&(tjUcmFormFinalSave=1),jQuery('input[type="checkbox"]').each(function(){1==jQuery(this).prop("checked")?a.append(jQuery(this).attr("name"),1):a.append(jQuery(this).attr("name"),0)}),com_tjucm.Services.Item.saveFormData(a,tjUcmItemForm.afterDataSave)}),jQuery("#item-form .toggle-editor a").each(function(e){this.click()})},saveSectionData:function(e){jQuery(".form-actions button[type='button'], .form-actions input[type='button']").attr("disabled",!0);var t=new FormData,a=jQuery(e).find("input, textarea, select, fieldset");if(!tjUcmItemForm.validateSection(a))return jQuery("html, body").animate({scrollTop:jQuery("#item-form").position().top},"slow"),!1;jQuery("#system-message-container").html(""),jQuery("#item-form .toggle-editor a").each(function(e){this.click()}),a.length&&a.each(function(){"file"==jQuery(this).attr("type")?null!=jQuery(this)[0].files[0]&&t.append(jQuery(this).attr("name"),jQuery(this)[0].files[0]):"checkbox"==jQuery(this).attr("type")?1==jQuery(this).prop("checked")?jQuery(this).val(1):jQuery(this).val(0):null!=jQuery(this).val()&&t.append(jQuery(this).attr("name"),jQuery(this).val())}),jQuery(".form-actions button[type='button'], .form-actions input[type='button']").attr("disabled",!0),tjUcmItemForm.getUcmParentRecordId(1,function(){t.delete("task"),t.delete("option"),t.delete("view"),t.delete("layout");var a=jQuery("#item-form").find("input[name='jform[client]']").val(),r=jQuery("#item-form").find("input[name='jform[id]']").val();t.append(Joomla.getOptions("csrf.token"),1),t.append("client",a),t.append("recordid",r),t.append("tjUcmFormSection",jQuery("a[href='"+e+"']").html()),com_tjucm.Services.Item.saveFormData(t,tjUcmItemForm.afterDataSave)})},validateSection:function(e){var t,a,r,i,n,o=!0,u=[];for(i=0,n=e.length;i<n;i++)jQuery(e[i]).hasClass("novalidate")||!1===document.formvalidator.validate(e[i])&&(o=!1,u.push(e[i]));if(jQuery.each(document.formvalidator.custom,function(e,t){!0!==t.exec()&&(o=!1)}),!o&&u.length>0){for(t=Joomla.JText._("JLIB_FORM_FIELD_INVALID"),a={error:[]},i=u.length-1;i>=0;i--)(r=jQuery(u[i]).data("label"))&&a.error.push(t+r.text().replace("*",""));Joomla.renderMessages(a)}return o},setVisibilityOfNavigationButtons:function(){var e=jQuery("#tjucm_myTabTabs").find("li.active");jQuery(e).length&&(jQuery(e).next("li").length?jQuery("#next_button").attr("disabled",!1):jQuery("#next_button").attr("disabled",!0),jQuery(e).prev("li").length?jQuery("#previous_button").attr("disabled",!1):jQuery("#previous_button").attr("disabled",!0))}};function steppedFormSave(e,t,a){window.onbeforeunload=null,jQuery("#item-form .toggle-editor a").each(function(e){this.click()});var r=jQuery("#"+e),i=!1;if(jQuery("#form_status").val(t),"save"==t){if(!document.formvalidator.isValid("#item-form"))return jQuery(".form-actions button[type='button'], .form-actions input[type='button']").attr("disabled",!1),jQuery("html, body").animate({scrollTop:jQuery("#item-form").position().top},"slow"),!1;if(!confirm(Joomla.JText._("COM_TJUCM_ITEMFORM_SUBMIT_ALERT")))return jQuery(".form-actions button[type='button'], .form-actions input[type='button']").attr("disabled",!1),jQuery("html, body").animate({scrollTop:jQuery("#item-form").position().top},"slow"),!1;jQuery("#item-form").removeClass("dirty")}return r&&jQuery(r).ajaxSubmit({datatype:"JSON",async:!1,success:function(e){var r=JSON.parse(e);if(null!==r.messages&&null!==r.messages.error&&(jQuery.each(r.messages.error,function(e,t){Joomla.renderMessages({error:[t]})}),jQuery("html, body").animate({scrollTop:jQuery("#item-form").position().top},"slow")),null!==r.message&&""!=r.message&&(Joomla.renderMessages({info:[r.message]}),jQuery("html, body").animate({scrollTop:jQuery("#item-form").position().top},"slow")),null!==r.data){jQuery("#recordId").val(r.data.id),"save"==t?(jQuery("#tjUcmSectionFinalSave").attr("disabled","disabled"),Joomla.renderMessages({success:[Joomla.JText._("COM_TJUCM_MSG_ON_SAVED_FORM")]}),jQuery("html, body").animate({scrollTop:jQuery("#system-message-container").offset().top-40},"slow")):(i=!0,"1"===a&&(jQuery("#draft_msg").show(),setTimeout(function(){jQuery("#draft_msg").hide()},5e3)));var n=window.location.href.split("#")[0],o=-1===n.indexOf("?")?"?":"&",u="id="+r.data.id;jQuery.each(r.data.childContentIds,function(e,t){jQuery("input[name='"+t.elementName+"']").val(t.content_id)}),tjucmRelatedFieldUpdatedOptions=r.data.relatedFieldOptions,jQuery.each(r.data.relatedFieldOptions,function(e,t){jQuery("#"+t.elementId).html(""),jQuery.each(t.options,function(e,a){var r="";"1"==a.selected&&(r=' selected="selected" '),jQuery("#"+t.elementId).append('<option value="'+a.value+'" '+r+">"+a.text+"</option>")}),jQuery("#"+t.elementId).trigger("liszt:updated")}),n.indexOf(u)>=0||(n+=o+u),history.pushState(null,null,n)}jQuery("#tjUcmSectionDraftSave").attr("disabled",!1),jQuery("#tjUcmSectionFinalSave").attr("disabled",!1),jQuery("#item-form .toggle-editor a").each(function(e){this.click()})}}),i}function itemformactions(e,t){var a=jQuery("ul#tjucm_myTabTabs").find("li.active a");null==jQuery(a).next("li")?jQuery("#previous_button").attr("disabled",!0):jQuery("#previous_button").attr("disabled",!1),null==jQuery(a).prev("li")?jQuery("#next_button").attr("disabled",!0):jQuery("#next_button").attr("disabled",!1),next?jQuery("#tjucm_myTabTabs > .active").next("li").find("a").trigger("click"):jQuery("#tjucm_myTabTabs > .active").next("li").prev("a").trigger("click");var r=jQuery("ul#"+getTabId).find("li.active").next("li").children("a").attr("href"),i=jQuery("ul#"+getTabId).find("li.active").prev("li").children("a").attr("href");null==r?jQuery("#next_button").attr("disabled",!0):jQuery("#next_button").attr("disabled",!1),null==i?jQuery("#previous_button").attr("disabled",!0):jQuery("#previous_button").attr("disabled",!1),steppedFormSave("item-form","draft",1),"next"==t&&jQuery("#"+getTabId+" > .active").next("li").find("a").trigger("click"),"prev"==t&&jQuery("#"+getTabId+" > .active").prev("li").find("a").trigger("click")}
